const config=require("../config"),fs=require("fs"),fs_promis=require("fs/promises"),log=require("../libs/log")(module),objectId=require("mongodb").ObjectId,User=require("../models/user.js").User,access=fs_promis.access,constants=fs.constants;async function isAvaFileAviable(e){const s=config.get("avatarPathFromServer")+e+".jpg";let t;try{await access(s,constants.F_OK),t=!0}catch{t=!1}return t}exports.searchInDB=async function(e,s){const t=e.body.query,n={_id:1,username:1},r=e.session.user._id;let a=new Array;const i=new RegExp(t,"ui");if(await User.find({username:i},n).then((function(e){e.forEach(e=>{a.push(e)})})).catch((function(e){throw s.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e})),24==t.length&&!t.startsWith("@")||25==t.length&&t.startsWith("@")){let e=t;25==t.length&&t.startsWith("@")&&(e=t.slice(1)),e=new objectId(e),await User.findById(e,n).then((function(e){e._id!=r&&a.push(e)})).catch((function(e){throw s.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}))}let c=new Array;for(let e=0;e<a.length;e++){let s={};s.username=a[e].username,s._id=a[e]._id,await isAvaFileAviable(s._id).then((function(e){s.imgURL=e?config.get("avatarPathFromClient")+s._id+".jpg":"",c.push(s)}))}a=c,s.status(200).render("searchResultList/searchResultList.pug",{users:a})};