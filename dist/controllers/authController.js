const config=require("../config"),fs=require("fs"),log=require("../libs/log")(module),User=require("../models/user.js").User;function renderBody(e,s,n){e.session.user=s.locals.user=n,e.session.save();let r={username:n.username,id:n._id},o=config.get("avatarPathFromServer")+n._id+".jpg";fs.access(o,fs.constants.F_OK,(function(e){e||(r.avaUrl=config.get("avatarPathFromClient")+n._id+".jpg"),s.status(200).render("signedPageBody/signedPageBody.pug",r)}))}exports.loginUser=function(e,s){const n=e.body.name,r=e.body.pass;User.findOne({username:n},(function(n,o){if(n)throw log.error("\nerr.name:\n    "+n.name+"\nerr.message:\n    "+n.message+"\nerr.stack:\n    "+n.stack),s.sendStatus(500),n;o||s.sendStatus(404),o&&(o.checkPassword(r)?renderBody(e,s,o):s.sendStatus(403))}))},exports.logoutUser=function(e,s){e.session.destroy(),s.status(200).render("notSignedPageBody/notSignedPageBody.pug")},exports.deleteUser=function(e,s){let n=e.session.user._id;User.findByIdAndDelete(n,(function(n,r){if(n)throw log.error("\nerr.name:\n    "+n.name+"\nerr.message:\n    "+n.message+"\nerr.stack:\n    "+n.stack),n;e.session.destroy(),s.status(200).render("notSignedPageBody/notSignedPageBody.pug")}))},exports.registerUser=function(e,s){const n=e.body.name,r=e.body.pass,o=e.body.lang;User.create({username:n,password:r,language:o},(function(n,r){n?log.error("\nerr.name:\n    "+n.name+"\nerr.message:\n    "+n.message+"\nerr.stack:\n    "+n.stack):renderBody(e,s,r)}))},exports.existUser=function(e,s){const n=e.body.name;User.findOne({username:n},(function(e,n){if(e)throw log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),s.status(500),e;n||s.status(200).send("free"),n&&s.status(200).send("used")}))};