const config=require("../config"),fs=require("fs"),fs_promis=require("fs/promises"),log=require("../libs/log")(module),objectId=require("mongodb").ObjectId,GroupChat=require("../models/groupchat.js").GroupChat,MonoChat=require("../models/monochat.js").MonoChat,User=require("../models/user.js").User,access=fs_promis.access,constants=fs.constants;async function getAvaFileClientURL(e){return await isAvaFileAviable(e)?config.get("avatarPathFromClient")+e+".jpg":""}async function isAvaFileAviable(e){const t=config.get("avatarPathFromServer")+e+".jpg";let n;try{await access(t,constants.F_OK),n=!0}catch{n=!1}return n}async function isAdmin(e,t,n){let a;return await GroupChat.findById(new objectId(t)).then(t=>{let n=t.meta.admins;a=!(n.indexOf(e)<0)}).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),a}async function isInContactList(e,t,n){let a;return await User.findById(new objectId(e),{contacts:1}).then(e=>{a=!(e.contacts.indexOf(t)<0)}).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),a}async function isInBlockList(e,t,n){let a;return await User.findById(new objectId(e),{blocklist:1}).then(e=>{a=!(e.blocklist.indexOf(t)<0)}).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),a}exports.renderContactsList=async function(e,t){let n=e.session.user._id,a=await User.findById(new objectId(n),{contacts:1}).then(e=>e.contacts).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});if(a.length){let e=[];for(let n=0;n<a.length;n++){let s=await User.findById(new objectId(a[n]),{username:1,status:1}).then(e=>e).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),r={_id:a[n]};r.imgURL=await getAvaFileClientURL(a[n]).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),r.username=s.username,r.status=s.status,e.push(r)}e.sort((function(e,t){return e.username>t.username?1:e.username<t.username?-1:e.username==t.username?0:void 0})),t.status(200).render("contactlist/contactlist.pug",{users:e})}else t.status(200).send("")},exports.renderChatsList=async function(e,t){const n=e.session.user._id;let a=[],s=await User.findById(new objectId(n),{monochats:1,groupchats:1}).then(e=>e).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});for(let e=0;e<s.monochats.length;e++){let r={_id:s.monochats[e],meta:"mono"};r.name=await User.findById(new objectId(s.monochats[e]),{username:1}).then(e=>e.username).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),r.imgURL=await getAvaFileClientURL(s.monochats[e]).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});let o,c=await MonoChat.find({interlocutors:{$all:[n,s.monochats[e]]}}).then(e=>e[0]&&e[0].chat?e[0].chat:[]).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),i=0;if(c.length){if(o=c[c.length-1],r.datetime=+o.datatime+0,r.message=o.message,r.status=o.status,o.who!=n&&"delivered"==o.status)for(let e=c.length-1;e>-1&&(c[e].who!=n&&"delivered"==c[e].status);e--)i+=1}else r.datetime="",r.message="...",r.status="read";r.badge=i,a.push(r)}for(let e=0;e<s.groupchats.length;e++){let r={_id:s.groupchats[e],meta:"group"},o=await GroupChat.findById(new objectId(s.groupchats[e]),{meta:1,chat:1}).then(e=>{let t,a,s,r,o=e.meta.name,c=0;e.chat.length?(t=e.chat[e.chat.length-1],a=+t.datatime+0,s=t.message,r=t.status[n]):(t="",a="",s="...",r="read");let i=e.chat[e.chat.length-1];if(i&&i.who!=n&&"delivered"==i.status[n])for(let t=e.chat.length-1;t>-1&&(e.chat[t].who!=n&&"delivered"==e.chat[t].status[n]);t--)c+=1;return{name:o,datetime:a,message:s,status:r,badge:c}}).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});r.name=o.name,r.datetime=o.datetime,r.message=o.message,r.status=o.status,r.badge=o.badge,r.imgURL=await getAvaFileClientURL(s.groupchats[e]).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),a.push(r)}a.sort((function(e,t){return e.datatime>t.datatime?1:e.datatime<t.datatime?-1:e.datatime==t.datatime?0:void 0})),t.status(200).render("chatlist/chatlist.pug",{chats:a})},exports.renderBlackList=function(e,t){let n=e.session.user._id;User.findById(new objectId(n),{blocklist:1},(function(e,n){if(e)throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e;let a=n.blocklist;if(a.length){let e=[];a.forEach(async(n,s)=>{await User.findById(new objectId(n),{username:1,status:1}).then((async function(t){let a={};a.username=t.username,a._id=t._id,await isAvaFileAviable(n)?a.imgURL=config.get("avatarPathFromClient")+n+".jpg":a.imgURL="",e.push(a)})).catch((function(e){throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e})),s==a.length-1&&(e.sort((function(e,t){return e.username>t.username?1:e.username<t.username?-1:e.username==t.username?0:void 0})),t.status(200).render("blackList/blackList.pug",{users:e}))})}else t.status(200).send("")}))},exports.renderUserCard=async function(e,t){const n=e.session.user._id,a=e.body.id;let s={id:a};await User.findById(new objectId(a),{}).then(e=>{s.name=e.username,s.initials=e.username.slice(0,2).toUpperCase()}).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),await isAvaFileAviable(a)?s.imgURL=config.get("avatarPathFromClient")+a+".jpg":s.imgURL="",await isInContactList(n,a,t)?s.isInContacts=!0:s.isInContacts=!1,await isInBlockList(n,a,t)?s.isInBlockList=!0:s.isInBlockList=!1,t.status(200).render("usercard/usercard.pug",s)},exports.renderGroupCard=async function(e,t){const n=e.session.user._id,a=e.body.id;let s={groupID:a,imgURL:await getAvaFileClientURL(a),groupName:await GroupChat.findById(new objectId(a),{meta:1}).then(e=>e.meta.name).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),isUserAdmin:await isAdmin(n,a,t).then(e=>e).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e})};t.status(200).render("groupcard/groupcard.pug",s)},exports.renderContactSubheader=async function(e,t){const n=e.body.id;let a=await User.findById(new objectId(n),{username:1}).then(e=>e).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),s={};s.name=a.username,s._id=a._id,await isAvaFileAviable(n)?s.imgURL=config.get("avatarPathFromClient")+n+".jpg":s.imgURL="",a=s,t.status(200).render("subheader/subheader.pug",a)},exports.renderGroupSubheader=async function(e,t){const n=e.body.id;let a={_id:n,group:!0,name:await GroupChat.findById(new objectId(n),{meta:1}).then(e=>e.meta.name).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),imgURL:await getAvaFileClientURL(n)};t.status(200).render("subheader/subheader.pug",a)},exports.renderMonoChat=async function(e,t){const n=e.body.id,a=e.session.user._id;if(await User.findById(new objectId(a),{monochats:1}).then((function(e){return!(e.monochats.indexOf(n)<0)})).catch((function(e){throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}))){const s=e.session.user.username,r=await User.findById(new objectId(n),{username:1}).then((function(e){return e.username})).catch((function(e){throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}));let o=await getAvaFileClientURL(a),c=await getAvaFileClientURL(n),i=await MonoChat.find({interlocutors:{$all:[a,n]}}).then((function(e){return e[0]?e[0].chat:[]})).catch((function(e){throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}));i.forEach(e=>{e.id=e.datatime,e.datatime=+e.datatime+0,e.who==a?(e.whoID=a,e.whoName=s,e.whomName=r,e.whoImg=o,e.messageType="chat-list__item_sent"):(e.whoName=r,e.whomName=s,e.whoImg=c,e.messageType="chat-list__item_received")});let m={meta:"mono",chatID:n,interlocutors:{user:a,contact:n},chat:i};t.status(200).render("chat/chat.pug",m)}else{let e={meta:"mono",chatID:n,interlocutors:{user:a,contact:n},chat:[]};t.status(200).render("chat/chat.pug",e)}},exports.renderGroupChat=async function(e,t){const n=e.body.id,a=e.session.user._id;if(await GroupChat.findById(new objectId(n)).then((function(e){return!!e})).catch((function(e){throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}))){let e={},s=await GroupChat.findById(new objectId(n),{interlocutors:1}).then(e=>e.interlocutors).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});for(let n=0;n<s.length;n++){let a=s[n],r=await User.findById(new objectId(a),{username:1}).then(e=>e.username).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),o=await getAvaFileClientURL(a);e[a]={username:r,imgURL:o}}let r=await GroupChat.findById(new objectId(n)).then((function(e){return e.chat})).catch((function(e){throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}));r.forEach(t=>{t.id=t.datatime,t.datatime=+t.datatime+0,t.whoName=e[t.who].username,t.whoImg=e[t.who].imgURL,t.status=t.status[a],t.who==a?t.messageType="chat-list__item_sent":t.messageType="chat-list__item_received"});let o={meta:"group",chatID:n,interlocutors:{},chat:r};t.status(200).render("chat/chat.pug",o)}else console.log("такого чату в колекції нема")},exports.renderGList=async function(e,t){const n=e.body.id;let a=[];const s=await GroupChat.findById(new objectId(n),{interlocutors:1}).then(e=>e.interlocutors).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});for(let e=0;e<s.length;e++){let n={_id:s[e]};n.username=await User.findById(new objectId(n._id),{username:1}).then(e=>e.username).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),n.imgURL=await getAvaFileClientURL(n._id),a.push(n)}t.status(200).render("memberslist/memberslist.pug",{users:a})},exports.contactsListGroupPopup=async function(e,t){let n=e.session.user._id,a=await User.findById(new objectId(n),{contacts:1}).then(e=>e.contacts).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),s=[];for(let e=0;e<a.length;e++){let n={_id:a[e]};n.username=await User.findById(new objectId(a[e]),{username:1}).then(e=>e.username).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),s.push(n)}s.sort((function(e,t){return e.username>t.username?1:e.username<t.username?-1:e.username==t.username?0:void 0})),t.status(200).render("lists/contactsInGroupPopup.pug",{users:s})},exports.contactsListGroupPopupPost=async function(e,t){let n=e.session.user._id,a=e.body.id,s=await GroupChat.findById(new objectId(a),{interlocutors:1}).then(e=>e.interlocutors).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),r=await User.findById(new objectId(n),{contacts:1}).then(e=>e.contacts).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),o=[];for(let e=0;e<r.length;e++){let n={_id:r[e]};n.username=await User.findById(new objectId(r[e]),{username:1}).then(e=>e.username).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),s.indexOf(r[e])>=0?n.isMember=!0:n.isMember=!1,o.push(n)}o.sort((function(e,t){return e.username>t.username?1:e.username<t.username?-1:e.username==t.username?0:void 0})),t.status(200).render("lists/contactsInGroupPopup.pug",{users:o})},exports.membersListGroupPopup=async function(e,t){let n=e.body.id,a=await GroupChat.findById(new objectId(n),{interlocutors:1}).then(e=>e.interlocutors).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),s=[];for(let e=0;e<a.length;e++){let n={_id:a[e]};n.username=await User.findById(new objectId(a[e]),{username:1}).then(e=>e.username).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),s.push(n)}s.sort((function(e,t){return e.username>t.username?1:e.username<t.username?-1:e.username==t.username?0:void 0})),t.status(200).render("lists/membersInGroupPopup.pug",{users:s})},exports.matchedIDList=async function(e,t){const n=e.body.id;console.log("searchedID",n);new RegExp("^"+n,"ui");let a=await User.findById(new objectId(n),{_id:1,username:1}).then(e=>e).catch(e=>{throw t.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});t.status(200).render("lists/searchResultInGroupPopup.pug",a)};