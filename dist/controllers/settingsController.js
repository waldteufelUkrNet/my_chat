const log=require("../libs/log")(module),GroupChat=require("../models/groupchat.js").GroupChat,objectId=require("mongodb").ObjectId,User=require("../models/user.js").User;exports.changeAva=function(e,n){e.file?n.status(200).send(e.file.filename):n.sendStatus(500)},exports.changeGroupAva=function(e,n){e.file?n.status(200).send(e.file.filename):n.sendStatus(500)},exports.checkOldPassword=function(e,n){const s=e.session.user._id,r=e.body.pass;User.findById(s,(function(e,s){if(e)throw log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),n.sendStatus(500),e;{let e=s.checkPassword(r);n.status(200).send(e)}}))},exports.changePassword=function(e,n){const s=e.session.user._id,r=e.body.pass;User.findById(s,(function(e,s){if(e)throw log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),n.sendStatus(500),e;s.set("password",r),s.save((function(e){if(e)throw log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),n.sendStatus(500),e})),n.sendStatus(200)}))},exports.changeUserName=function(e,n){const s=e.session.user._id,r=e.body.username;User.findByIdAndUpdate(s,{username:r},(function(e,s){if(e)throw log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),n.sendStatus(500),e;n.sendStatus(200)}))},exports.manageGroup=async function(e,n){const s=e.session.user._id,r=e.body.id,t=e.body.name||"unnamed",a=e.body.members;if(a.indexOf(s)<0&&a.push(s),r){let e=await GroupChat.findById(new objectId(r),{interlocutors:1,meta:1}).then(e=>e).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),s=e.meta.name,o=e.interlocutors;for(let e=0;e<o.length;e++)a.indexOf(o[e])<0&&await User.findByIdAndUpdate(new objectId(o[e]),{$pull:{groupchats:r}}).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});for(let e=0;e<a.length;e++)o.indexOf(a[e])<0&&await User.findByIdAndUpdate(new objectId(a[e]),{$push:{groupchats:r}}).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});await GroupChat.findByIdAndUpdate(new objectId(r),{interlocutors:a}).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),s!=t&&await GroupChat.findByIdAndUpdate(new objectId(r),{"meta.name":t}).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e}),n.sendStatus(200)}else{let e={meta:{name:t,admins:[s]},interlocutors:a,chat:[]},r=await GroupChat.create(e).then(e=>String(e._id)).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});for(let e=0;e<a.length;e++)await User.findByIdAndUpdate(new objectId(a[e]),{$push:{groupchats:r}}).catch(e=>{throw n.sendStatus(500),log.error("\nerr.name:\n    "+e.name+"\nerr.message:\n    "+e.message+"\nerr.stack:\n    "+e.stack),e});n.sendStatus(200)}};